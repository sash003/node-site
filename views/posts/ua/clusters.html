Node.js за промовчанням працює в одному процесі та використовує одне ядро ​​процесора. На багатопроцесорних серверах це створює обмеження щодо продуктивності. Рішення – кластеризація та керування процесами за допомогою PM2.
<h2>Cluster модуль</h2>
Cluster — вбудований модуль Node.js, який дозволяє запускати кілька процесів (воркерів), кожен із яких обслуговує запити. Master-процес розподіляє навантаження між воркерами.
Найпростіший приклад:
<pre><code class="language-javascript">
// Підключаємо модуль cluster для роботи з кластерами
const cluster = require('cluster');
// Модуль http необхідний створення сервера
const http = require ('http');
// os дозволяє дізнатися кількість доступних ядер CPU
const os = require('os');

// Перевіряємо: якщо це головний процес (майстер)
if (cluster.isMaster) {
  // Отримуємо кількість доступних процесорів
  const numCPUs = os.cpus().length;
  console.log(`Master-процес ${process.pid} запущено`);

  // Запускаємо стільки воркерів, скільки ядер у CPU
  for (let i = 0; i <numCPUs; i++) {
    cluster.fork(); // створюємо новий процес-воркер
  }

  // Обробник події: якщо воркер завершився
  cluster.on('exit', (worker) => {
    console.log(`Воркер ${worker.process.pid} помер, перезапускаємо...`);
    // Створюємо новий воркер замість того, хто впав
    cluster.fork();
  });

  // Якщо це не майстер - значить, воркер
} else {
  // Кожен воркер піднімає свій HTTP-сервер
  http.createServer((req, res) => {
    res.writeHead(200); // Статус відповіді 200 OK
    res.end('Привіт від воркера' + process.pid); // виводимо PID процесу
  }).listen(3000); // сервер слухає порт 3000

  console.log(`Воркер ${process.pid} запущено`);
}
</code></pre>
Що тут відбувається?
isMaster - перевіряє, чи запущений код у головному процесі.
Майстер створює N воркерів за кількістю ядер процесора.
Кожен воркер – окремий Node.js процес зі своїм сервером.
Запити автоматично балансуються між воркерами.
Якщо один воркер падає, майстер його перезапускає.
Тепер програма використовує всі ядра процесора, а при падінні воркера він автоматично перезапускається.
<h2>Плюси cluster</h2>
<ul>
  <li>Залучення всіх ядер CPU</li>
  <li>Балансування навантаження вбудованими засобами</li>
  <li>Автоперезапуск воркерів під час збою</li>
</ul>
<h2>PM2 - менеджер процесів</h2>
PM2 – популярний інструмент для продакшн-запуску Node.js додатків. Він керує процесами, балансує навантаження та забезпечує моніторинг.
Встановлення:
<pre><code class="language-javascript">
npm install pm2 -g
</code></pre>
Запуск програми:
<pre><code class="language-javascript">
pm2 start app.js -i max
</code></pre>
Тут <code>-i max</code> означає "використовувати всі ядра CPU". Можна вказати конкретну кількість процесів.

<h2>Основні команди PM2</h2>
<pre><code class="language-javascript">
pm2 list # список процесів
pm2 stop 0 # зупинити процес
pm2 restart all # перезапустити всі процеси
pm2 monit # моніторинг ресурсів
pm2 logs # перегляд логів
</code></pre>

<h2>Навіщо поєднувати cluster та PM2</h2>
<ul>
  <li>Cluster дозволяє використовувати багатопоточність у Node.js</li>
  <li>PM2 додає зручне керування, моніторинг та автозавантаження під час старту сервера</li>
  <li>Разом вони дають стабільність та масштабованість для продакшн-середовища</li>
</ul>

<h2>Підсумок</h2>
Для локальної розробки можна використовувати вбудований cluster. Для продакшна краще запускати програму через PM2 — це позбавляє ручного управління процесами і дозволяє легко масштабувати проект під навантаження.