
JWT, Passport.js и сессии в Node.js — это основа для безопасной аутентификации пользователей. Разберём подходы и различия между хранением данных в cookie и localStorage.
<h2>Что такое аутентификация и сессии</h2>
Аутентификация — процесс подтверждения личности пользователя.
Сессия — это способ хранить состояние пользователя между запросами. В веб-приложениях сессии нужны, чтобы пользователь оставался «в системе» без повторного логина на каждом запросе.
<h2>JWT (JSON Web Token)</h2>
JWT — это компактный токен, который можно передавать между клиентом и сервером.
Он состоит из трёх частей: header, payload и signature.
Токен создаётся сервером после успешного логина и подписывается секретом.
Клиент хранит токен и отправляет его в каждом запросе (обычно в Authorization header).
<h2>Passport.js</h2>
Passport.js — популярный middleware для Node.js, который упрощает аутентификацию.
Он поддерживает локальные стратегии (логин + пароль), OAuth (Google, Facebook), JWT и другие.
Пример с локальной стратегией:
<pre><code class="language-javascript">
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

passport.use(new LocalStrategy(
  function(username, password, done) {
    User.findOne({ username }, function(err, user) {
      if (err) return done(err);
      if (!user) return done(null, false);
      if (!user.verifyPassword(password)) return done(null, false);
      return done(null, user);
    });
  }
));
</code></pre>
<h2>Cookie vs localStorage</h2>
Оба варианта могут хранить токены или сессионные данные, но есть различия:

Cookie
* Отправляется автоматически с каждым HTTP-запросом к домену.
* Может быть HttpOnly — недоступна из JS, защищает от XSS.
* Можно установить срок жизни, домен и путь.

localStorage
* Доступна только через JavaScript.
* Не отправляется автоматически на сервер.
* Уязвима к XSS, но проще для SPA (single-page applications).
<h2>Пример с JWT и cookie</h2>
1. Сервер создаёт JWT после логина:
<pre><code class="language-javascript">
const jwt = require('jsonwebtoken');
const token = jwt.sign({ id: user.id }, 'secret', { expiresIn: '1h' });
res.cookie('token', token, { httpOnly: true });
res.send({ success: true });
</code></pre>
2. Клиент при каждом запросе использует cookie автоматически.
3. На сервере проверка токена:
<pre><code class="language-javascript">
const token = req.cookies.token;
jwt.verify(token, 'secret', (err, decoded) => {
  if (err) return res.status(401).send('Unauthorized');
  req.user = decoded;
  next();
});
</code></pre>
<h2>Вывод</h2>
- Для REST API и SPA часто используют JWT + localStorage.
- Для традиционных серверных приложений с рендерингом HTML удобнее WT или сессии в HttpOnly cookie.
- Passport.js упрощает работу с различными стратегиями.

Правильная комбинация зависит от типа приложения, требований безопасности и архитектуры.

<h2>Пример аутентификации Node.js + Express с Passport.js, JWT и cookie.</h2>
<h2>Установка зависимостей</h2>
Перед началом установим необходимые пакеты:
<pre><code class="language-javascript">
npm install express passport passport-local jsonwebtoken cookie-parser body-parser bcrypt
</code></pre>
<h2>Фронтэнд</h2>
HTML + jQuery форма логина/логаута + проверка профиля
<pre><code class="language-html">
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Аутентификация JWT + cookie</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h2>Вход</h2>
  <form id="loginForm">
    <input type="text" id="username" placeholder="Логин" required><br>
    <input type="password" id="password" placeholder="Пароль" required><br>
    <button type="submit">Войти</button>
  </form>

  <button id="logoutBtn" style="display:none;">Выйти</button>
  <button id="profileBtn" style="display:none;">Мой профиль</button>

  <div id="output"></div>

  <script>
    // Логин
    $('#loginForm').on('submit', function (e) {
      e.preventDefault();
      $.ajax({
        url: '/login',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          username: $('#username').val(),
          password: $('#password').val()
        }),
        success: function (res) {
          $('#output').text(res.message);
          $('#loginForm').hide();
          $('#logoutBtn, #profileBtn').show();
        },
        error: function (xhr) {
          $('#output').text(xhr.responseJSON?.message || 'Ошибка входа');
        }
      });
    });

    // Профиль
    $('#profileBtn').on('click', function () {
      $.ajax({
        url: '/profile',
        method: 'GET',
        success: function (res) {
          $('#output').text(res.message);
        },
        error: function () {
          $('#output').text('Не авторизован');
        }
      });
    });

    // Выход
    $('#logoutBtn').on('click', function () {
      $.ajax({
        url: '/logout',
        method: 'POST',
        success: function (res) {
          $('#output').text(res.message);
          $('#loginForm').show();
          $('#logoutBtn, #profileBtn').hide();
        }
      });
    });
  </script>
</body>
</html>
</code></pre>
<h2>app.js — основной сервер</h2>
<pre><code class="language-javascript">
const express = require('express');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;
const jwt = require('jsonwebtoken');
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');
const bcrypt = require('bcrypt');

const app = express();
const port = 3000;

// Фейковая база пользователей (сразу с хешем)
const users = [
  { id: 1, username: 'user1', passwordHash: bcrypt.hashSync('password', 10) }
];

// Middleware
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(cookieParser());
app.use(passport.initialize());

// Настройка стратегии Passport.js (логин/пароль)
passport.use(new LocalStrategy(
  function (username, password, done) {
    const user = users.find(u => u.username === username);
    if (!user) return done(null, false, { message: 'Неверный логин' });

    if (!bcrypt.compareSync(password, user.passwordHash)) {
      return done(null, false, { message: 'Неверный пароль' });
    }

    return done(null, user);
  }
));

// Роут логина
app.post('/login', (req, res, next) => {
  passport.authenticate('local', (err, user, info) => {
    if (err) return next(err);
    if (!user) return res.status(401).json({ success: false, message: info.message });

    // Генерация JWT
    const token = jwt.sign(
      { id: user.id, username: user.username },
      'secret',             // секрет для подписи (лучше вынести в .env)
      { expiresIn: '1h' }
    );

    // Отправка токена в cookie (HttpOnly)
    res.cookie('token', token, { httpOnly: true });
    res.json({ success: true, message: 'Успешный вход' });
  })(req, res, next); // вызов колбэка authenticate
});

// Middleware для проверки JWT из cookie
function authenticateJWT(req, res, next) {
  const token = req.cookies.token;
  if (!token) return res.status(401).send('Unauthorized');

  jwt.verify(token, 'secret', (err, decoded) => {
    if (err) return res.status(401).send('Unauthorized');
    req.user = decoded;
    next();
  });
}

// Приватный роут
app.get('/profile', authenticateJWT, (req, res) => {
  res.json({ message: `Добро пожаловать, ${req.user.username}` });
});

// Logout
app.post('/logout', (req, res) => {
  res.clearCookie('token');
  res.json({ success: true, message: 'Вы вышли' });
});

// Старт сервера
app.listen(port, () => console.log(`Server running on http://localhost:${port}`));

</code></pre>
<h2>Как работает</h2>
- Пользователь отправляет POST на `/login` с `username` и `password`.
- Passport проверяет логин и пароль.
- Если всё верно, сервер создаёт JWT и отправляет его в HttpOnly cookie.
- Любой роут с middleware `authenticateJWT` проверяет cookie и расшифровывает токен.
- Logout просто очищает cookie.
<h2>Безопасность</h2>
- JWT в cookie HttpOnly защищает от XSS.
- Для SPA можно использовать localStorage, но тогда нужно учитывать CSRF.
- Passport.js позволяет легко подключать OAuth и другие стратегии.

<h2>JWT Авторизация через LocalStorage</h2>
Фротнэнд
<pre><code class="language-html">
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>JWT + LocalStorage</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { margin-bottom: 20px; }
    input, button { margin: 5px; padding: 6px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; margin-top: 10px; }
  </style>
</head>
<body>
<h1>JWT Авторизация через LocalStorage</h1>

<form id="loginForm">
  <input type="text" id="username" placeholder="Логин" required>
  <input type="password" id="password" placeholder="Пароль" required>
  <button type="submit">Войти</button>
</form>

<button id="getProfile">Профиль</button>
<button id="logout">Выйти</button>

<pre id="output"></pre>

<script>
  const API = "http://localhost:3000";

  // Логин
  $("#loginForm").submit(function(e) {
    e.preventDefault();
    $.post(API + "/login", {
      username: $("#username").val(),
      password: $("#password").val()
    }, function(data) {
      if (data.success && data.token) {
        localStorage.setItem("jwt", data.token);
      }
      $("#output").text(JSON.stringify(data, null, 2));
    }).fail(err => {
      $("#output").text("Ошибка: " + err.responseJSON?.message);
    });
  });

  // Профиль
  $("#getProfile").click(function() {
    const token = localStorage.getItem("jwt");
    if (!token) return $("#output").text("Нет токена в localStorage");

    $.ajax({
      url: API + "/profile",
      method: "GET",
      headers: { "Authorization": "Bearer " + token },
      success: function(data) {
        $("#output").text(JSON.stringify(data, null, 2));
      },
      error: function() {
        $("#output").text("Нет доступа (LocalStorage)");
      }
    });
  });

  // Выход
  $("#logout").click(function() {
    localStorage.removeItem("jwt");
    $("#output").text("Вы вышли (localStorage очищен)");
  });
</script>
</body>
</html>
</code></pre>
Сервер
<pre><code class="language-javascript">
const express = require('express');
const jwt = require('jsonwebtoken');
const bodyParser = require('body-parser');
const bcrypt = require('bcrypt');
const cors = require('cors');

const app = express();
const port = 3000;

// Разрешаем CORS (для фронта)
app.use(cors());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false }));

// Мокаем базу пользователей
const users = [
  { id: 1, username: 'user1', passwordHash: bcrypt.hashSync('password', 10) }
];

// Секрет для JWT
const SECRET = 'super_secret_key';

// Логин — выдаём JWT
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  const user = users.find(u => u.username === username);

  if (!user) {
    return res.status(401).json({ success: false, message: 'Неверный логин' });
  }
  if (!bcrypt.compareSync(password, user.passwordHash)) {
    return res.status(401).json({ success: false, message: 'Неверный пароль' });
  }

  const token = jwt.sign({ id: user.id, username: user.username }, SECRET, { expiresIn: '1h' });
  res.json({ success: true, token });
});

// Middleware для проверки JWT
function authenticateJWT(req, res, next) {
  const authHeader = req.headers['authorization'];
  if (!authHeader) return res.status(401).json({ message: 'Нет токена' });

  const token = authHeader.split(' ')[1];
  jwt.verify(token, SECRET, (err, decoded) => {
    if (err) return res.status(403).json({ message: 'Недействительный токен' });
    req.user = decoded;
    next();
  });
}

// Приватный роут
app.get('/profile', authenticateJWT, (req, res) => {
  res.json({ message: `Добро пожаловать, ${req.user.username}` });
});

app.listen(port, () => console.log(`🚀 Server running on http://localhost:${port}`));
</code></pre>
<h2>Заключение</h2>
Аутентификация — это основа любой современной веб-разработки. Cookie и LocalStorage, Passport.js и JWT — всё это лишь инструменты, которые решают разные задачи. Нет «правильного» или «неправильного» варианта — есть подходящий для твоего проекта.

Если нужен классический веб с серверными шаблонами — бери cookie + сессии.
Если у тебя SPA или мобильное приложение — чаще всего подойдёт JWT через localStorage или cookie с HttpOnly.
Passport.js закрывает все вопросы интеграции со сторонними сервисами, а JWT хорош там, где нужна масштабируемость и микросервисы.

Главное — всегда думать о безопасности: шифровать данные, ставить правильные флаги на cookie, использовать HTTPS и не хранить лишнего в localStorage.

И помни: как бы сложно это ни казалось, под капотом всё сводится к простому правилу — ты даёшь пользователю токен, а сервер проверяет, что он настоящий. Всё остальное — детали реализации.