Node.js по умолчанию работает в одном процессе и использует одно ядро процессора. На многопроцессорных серверах это создаёт ограничение по производительности. Решение — кластеризация и управление процессами с помощью PM2.

<h2>Cluster модуль</h2>
Cluster — встроенный модуль Node.js, который позволяет запускать несколько процессов (воркеров), каждый из которых обслуживает запросы. Master-процесс распределяет нагрузку между воркерами.
Простейший пример:
<pre><code class="language-javascript">
// Подключаем модуль cluster для работы с кластерами
const cluster = require('cluster');
// Модуль http нужен для создания сервера
const http = require('http');
// os позволяет узнать количество доступных ядер CPU
const os = require('os');

// Проверяем: если это главный процесс (мастер)
if (cluster.isMaster) {
  // Получаем количество доступных процессоров
  const numCPUs = os.cpus().length;
  console.log(`Master-процесс ${process.pid} запущен`);

  // Запускаем столько воркеров, сколько ядер у CPU
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork(); // создаём новый процесс-воркер
  }

  // Обработчик события: если воркер завершился
  cluster.on('exit', (worker) => {
    console.log(`Воркер ${worker.process.pid} умер, перезапускаем...`);
    // Создаём новый воркер вместо упавшего
    cluster.fork();
  });

// Если это не мастер — значит, воркер
} else {
  // Каждый воркер поднимает свой HTTP-сервер
  http.createServer((req, res) => {
    res.writeHead(200); // статус ответа 200 OK
    res.end('Привет от воркера ' + process.pid); // выводим PID процесса
  }).listen(3000); // сервер слушает порт 3000

  console.log(`Воркер ${process.pid} запущен`);
}
</code></pre>
Что тут происходит:
isMaster — проверяет, запущен ли код в главном процессе.
Мастер создаёт N воркеров по числу ядер процессора.
Каждый воркер — отдельный Node.js процесс со своим сервером.
Запросы балансируются автоматически между воркерами.
Если один воркер падает, мастер его перезапускает.
Теперь приложение использует все ядра процессора, а при падении воркера он автоматически перезапускается.

<h2>Плюсы cluster</h2>
<ul>
  <li>Задействование всех ядер CPU</li>
  <li>Балансировка нагрузки встроенными средствами</li>
  <li>Автоперезапуск воркеров при сбое</li>
</ul>
<h2>PM2 — менеджер процессов</h2>
PM2 — популярный инструмент для продакшн-запуска Node.js приложений. Он управляет процессами, балансирует нагрузку и обеспечивает мониторинг.
Установка:
<pre><code class="language-javascript">
  npm install pm2 -g
</code></pre>
Запуск приложения:
<pre><code class="language-javascript">
  pm2 start app.js -i max
</code></pre>
Здесь <code>-i max</code> означает «использовать все ядра CPU». Можно указать конкретное число процессов.

<h2>Основные команды PM2</h2>
<pre><code class="language-javascript">
pm2 list         # список процессов
pm2 stop 0       # остановить процесс
pm2 restart all  # перезапустить все процессы
pm2 monit        # мониторинг ресурсов
pm2 logs         # просмотр логов
</code></pre>
<h2>Зачем сочетать cluster и PM2</h2>
<ul>
  <li>Cluster позволяет использовать многопоточность в Node.js</li>
  <li>PM2 добавляет удобное управление, мониторинг и автозагрузку при старте сервера</li>
  <li>Вместе они дают стабильность и масштабируемость для продакшн-среды</li>
</ul>
<h2>Итог</h2>
Для локальной разработки можно использовать встроенный cluster. Для продакшна лучше запускать приложение через PM2 — это избавляет от ручного управления процессами и позволяет легко масштабировать проект под нагрузку.
